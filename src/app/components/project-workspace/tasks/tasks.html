<div class="tasks-container">
    <div class="header">
        <div class="header-title-section">
            <button class="btn btn-secondary btn-sm" (click)="backToSprints()" title="Back to Sprints">
                <span class="back-arrow">‚Üê</span>
            </button>
            <h2>Tasks</h2>
        </div>
        <div class="header-actions">
            <!-- Employee View Toggle -->
            <div *ngIf="!isFounder" class="view-toggle">
                <button [class.active]="employeeView === 'mine'" (click)="toggleEmployeeView('mine')">My Tasks</button>
                <button [class.active]="employeeView === 'all'" (click)="toggleEmployeeView('all')">All Tasks</button>
            </div>
            <button class="btn btn-primary" *ngIf="isFounder && !showTaskForm" (click)="createTask()">+ New Task</button>
        </div>
    </div>

    <!-- Founder Filter Bar -->
    <div class="filter-bar" *ngIf="isFounder && !showTaskForm">
        <select [(ngModel)]="filters.assigneeId">
            <option [ngValue]="null">All Assignees</option>
            <option *ngFor="let member of members" [value]="member.userId">{{ member.userName }}</option>
        </select>
        <select [(ngModel)]="filters.status">
            <option [ngValue]="null">All Statuses</option>
            <option *ngFor="let status of taskStatuses" [value]="status">{{ status }}</option>
        </select>
        <select [(ngModel)]="filters.priority">
            <option [ngValue]="null">All Priorities</option>
            <option value="LOW">Low</option>
            <option value="MEDIUM">Medium</option>
            <option value="HIGH">High</option>
        </select>
        <label>
            <input type="checkbox" [(ngModel)]="filters.unassigned" />
            Unassigned
        </label>
        <button (click)="applyFilters()">Apply</button>
        <button (click)="loadInitialTasks()">Clear</button>
    </div>

    <div *ngIf="!showTaskForm">
        <div class="kanban-board" cdkDropListGroup>
            <div *ngFor="let status of taskStatuses" class="kanban-column">
                <div class="kanban-column-header">
                    <h3>{{ status.replace('_', ' ') }}</h3>
                    <span>{{ kanbanColumns[status].length }}</span>
                </div>
                <div class="kanban-tasks" [id]="status" cdkDropList [cdkDropListData]="kanbanColumns[status]"
                    (cdkDropListDropped)="drop($event)">
                    <div class="task-card kanban-card" *ngFor="let task of kanbanColumns[status]"
                        [cdkDragDisabled]="!isFounder && task.assigneeId !== authService.getCurrentUser()?.id" cdkDrag
                        (click)="openTaskDetail(task)">
                        <div class="task-header">
                            <h3>{{ task.title }}</h3>
                        </div>
                        <p class="task-description">{{ task.description }}</p>
                        <div class="task-footer">
                            <span class="priority" [class]="task.priority.toLowerCase()">{{ task.priority }}</span>
                            <div class="task-actions" *ngIf="isFounder">
                                <button class="btn btn-secondary btn-sm"
                                    (click)="editTask(task); $event.stopPropagation()">Edit</button>
                            </div>
                        </div>
                        <div *cdkDragPlaceholder class="cdk-drag-placeholder"></div>
                    </div>
                    <div class="empty-column-message" *ngIf="kanbanColumns[status].length === 0">
                        No tasks here.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <app-task-form *ngIf="showTaskForm" [task]="taskToEdit" (taskSubmitted)="handleTaskSubmitted($event)"
        (cancel)="handleCancel()">
    </app-task-form>

    <app-task-detail *ngIf="selectedTask" [task]="selectedTask" (close)="closeTaskDetail()"
        (taskUpdated)="loadInitialTasks()">
    </app-task-detail>
</div>